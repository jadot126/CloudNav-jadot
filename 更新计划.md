# CloudNav 项目更新执行计划

## 一、项目概述

**目标**：基于 reference 项目更新导航页，保留原有样式和基本功能，同时新增分组路由、嵌套分组、权限继承等功能。

**核心变更**：
1. 简化环境变量（仅保留 `CLOUDNAV_KV`）
2. 新增初始化管理员密码设置流程
3. 分组支持 URI 路由访问
4. 支持嵌套子分组
5. 分组级别密码验证与继承
6. 本地开发 Mock API

---

## 二、详细执行计划

### 阶段 1：项目基础搭建

| 任务 | 说明 | 状态 |
|------|------|------|
| 1.1 复制 reference 项目结构 | 将 reference 目录下的源码复制到项目根目录 | ✅ 已完成 |
| 1.2 清理环境变量 | 移除 `PASSWORD` 环境变量依赖，仅保留 `CLOUDNAV_KV` | ✅ 已完成 |
| 1.3 更新 Env 接口 | 修改 `functions/api/*.ts` 中的 `interface Env`，移除 `PASSWORD` | ✅ 已完成 |
| 1.4 创建 Mock API | 新建 `mock/` 目录，实现本地开发用的模拟 API | ✅ 已完成 |
| 1.5 配置 Vite 代理 | 在 `vite.config.ts` 中配置开发环境 API 代理到 Mock | ✅ 已完成 |

### 阶段 2：数据模型重构

| 任务 | 说明 | 状态 |
|------|------|------|
| 2.1 扩展 Category 接口 | 新增字段支持嵌套和路由 | ✅ 已完成 |
| 2.2 新增 AdminConfig 接口 | 存储管理员密码配置 | ✅ 已完成 |
| 2.3 更新 KV 存储结构 | 新增 `admin_config` 键存储管理员设置 | ✅ 已完成 |

**新 Category 接口设计**：
```typescript
interface Category {
  id: string;
  name: string;
  icon: string;
  uri: string;              // 新增：访问路径，如 "tools", "tools/dev"
  parentId?: string;        // 新增：父分组ID，支持嵌套
  password?: string;        // 分组密码
  inheritPassword?: boolean; // 新增：是否继承父分组密码
  order?: number;           // 排序
  createdAt?: number;
}
```

**AdminConfig 接口设计**：
```typescript
interface AdminConfig {
  password: string;         // 管理员密码（哈希存储）
  initialized: boolean;     // 是否已初始化
  createdAt: number;
}
```

### 阶段 3：后端 API 重构

| 任务 | 说明 | 状态 |
|------|------|------|
| 3.1 重构 storage.ts | 移除 `PASSWORD` 环境变量，改为从 KV 读取管理员密码 | ✅ 已完成 |
| 3.2 新增初始化检查 API | `GET /api/storage?checkInit=true` 检查是否已设置管理员密码 | ✅ 已完成 |
| 3.3 新增管理员设置 API | `POST /api/storage` with `initAdmin: true` 首次设置管理员密码 | ✅ 已完成 |
| 3.4 新增分组路由 API | `GET /api/storage?uri={path}` 根据 URI 获取分组数据 | ✅ 已完成 |
| 3.5 新增分组验证 API | `POST /api/storage` with `verifyGroup: true` 验证分组密码 | ✅ 已完成 |

**API 端点设计**：

| 方法 | 参数 | 用途 |
|------|------|------|
| GET | `checkInit=true` | 检查是否已初始化管理员 |
| GET | `uri={path}` | 根据 URI 获取分组及其链接 |
| POST | `initAdmin: true, password` | 首次设置管理员密码 |
| POST | `verifyGroup: true, groupId, password` | 验证分组访问密码 |
| POST | `verifyAdmin: true, password` | 验证管理员密码 |

### 阶段 4：前端路由实现

| 任务 | 说明 | 状态 |
|------|------|------|
| 4.1 安装 React Router | 添加 `react-router-dom` 依赖 | ✅ 已完成 |
| 4.2 创建路由配置 | 设置 `/`, `/:uri`, `/:uri/:subUri` 等路由 | ✅ 已完成 |
| 4.3 创建 InitSetup 页面 | 首次访问时的管理员密码设置页面 | ✅ 已完成 |
| 4.4 修改 App.tsx | 集成路由，根据 URL 加载对应分组 | ✅ 已完成 |
| 4.5 更新侧边栏导航 | 使用 `<Link>` 组件，支持嵌套分组展示 | ✅ 已完成 |

**路由结构设计**：
```
/                    → 首页（置顶/常用）
/setup               → 初始化设置页面（仅首次）
/tools               → tools 分组
/tools/dev           → tools 下的 dev 子分组
/tools/dev/frontend  → 三级嵌套分组
```

### 阶段 5：初始化流程实现

| 任务 | 说明 | 状态 |
|------|------|------|
| 5.1 创建 InitSetupPage 组件 | 管理员密码设置界面 | ✅ 已完成 |
| 5.2 实现初始化检查逻辑 | App 加载时检查是否已初始化 | ✅ 已完成 |
| 5.3 实现密码设置流程 | 首次设置管理员密码并存储到 KV | ✅ 已完成 |
| 5.4 添加密码强度验证 | 前端验证密码复杂度 | ✅ 已完成 |

**初始化流程**：
```
App 启动
    ↓
检查 KV 中 admin_config
    ↓
未初始化 → 跳转 /setup → 设置密码 → 存储到 KV → 跳转首页
    ↓
已初始化 → 正常加载应用
```

### 阶段 6：分组管理功能增强

| 任务 | 说明 | 状态 |
|------|------|------|
| 6.1 重构 CategoryManagerModal | 支持设置 URI、父分组、密码继承 | ✅ 已完成 |
| 6.2 新增 URI 输入组件 | 自动生成/手动编辑 URI | ✅ 已完成 |
| 6.3 新增父分组选择器 | 下拉选择父分组，支持树形展示 | ✅ 已完成 |
| 6.4 新增密码继承开关 | 切换是否继承父分组密码 | ✅ 已完成 |
| 6.5 实现 URI 唯一性验证 | 防止 URI 冲突 | ✅ 已完成 |
| 6.6 实现嵌套分组树形展示 | 侧边栏显示分组层级结构 | ✅ 已完成 |

### 阶段 7：分组访问验证

| 任务 | 说明 | 状态 |
|------|------|------|
| 7.1 创建 GroupAuthModal 组件 | 分组密码验证弹窗（增强 CategoryAuthModal） | ✅ 已完成 |
| 7.2 实现密码继承验证逻辑 | 父分组密码可访问所有子分组 | ✅ 已完成 |
| 7.3 实现会话级解锁状态 | 记录已解锁的分组 | ✅ 已完成 |
| 7.4 实现路由守卫 | 访问受保护分组时触发验证 | ✅ 已完成 |

**密码继承验证逻辑**：
```typescript
function verifyGroupAccess(groupId: string, password: string): boolean {
  const group = getGroup(groupId);

  // 1. 检查当前分组密码
  if (group.password && group.password === hash(password)) {
    return true;
  }

  // 2. 如果启用继承，检查父分组密码
  if (group.inheritPassword && group.parentId) {
    return verifyGroupAccess(group.parentId, password);
  }

  // 3. 无密码保护的分组直接通过
  if (!group.password) {
    return true;
  }

  return false;
}
```

### 阶段 8：前端代码优化

| 任务 | 说明 | 状态 |
|------|------|------|
| 8.1 拆分 App.tsx | 将大型组件拆分为更小的模块 | ✅ 已完成 |
| 8.2 创建 hooks 目录 | 提取自定义 hooks（useCategories, useLinks, useSearch）| ✅ 已完成 |
| 8.3 创建 contexts 目录 | 提取全局状态到 Context（AuthContext, DataContext）| ✅ 已完成 |
| 8.4 创建 layout 组件 | 提取 Sidebar 和 Header 布局组件 | ✅ 已完成 |
| 8.5 添加 TypeScript 严格模式 | 增强类型安全 | ✅ 已完成 |

**建议的目录结构**：
```
src/
├── components/          # UI 组件
│   ├── modals/         # 弹窗组件
│   ├── layout/         # 布局组件（Sidebar, Header）
│   └── common/         # 通用组件
├── hooks/              # 自定义 hooks
│   ├── useAuth.ts
│   ├── useCategories.ts
│   └── useLinks.ts
├── contexts/           # React Context
│   ├── AuthContext.tsx
│   └── DataContext.tsx
├── pages/              # 页面组件
│   ├── HomePage.tsx
│   ├── GroupPage.tsx
│   └── SetupPage.tsx
├── services/           # API 服务
├── utils/              # 工具函数
├── types/              # TypeScript 类型
└── mock/               # Mock API
```

### 阶段 9：Mock API 实现

| 任务 | 说明 | 状态 |
|------|------|------|
| 9.1 创建 mock 服务器 | 使用 Vite 插件实现 mock | ✅ 已完成 |
| 9.2 实现数据持久化 | 使用 localStorage 模拟 KV | ✅ 已完成 |
| 9.3 模拟所有 API 端点 | 覆盖 storage.ts 的所有功能 | ✅ 已完成 |
| 9.4 配置开发环境切换 | 通过环境变量切换 Mock/真实 API | ✅ 已完成 |

### 阶段 10：测试与文档

| 任务 | 说明 | 状态 |
|------|------|------|
| 10.1 功能测试 | 测试所有新功能 | 待开始 |
| 10.2 更新 CLAUDE.md | 更新项目文档 | 待开始 |
| 10.3 更新 README.md | 更新部署说明 | 待开始 |
| 10.4 清理代码 | 移除未使用的代码和依赖 | 待开始 |

---

## 三、关键技术决策

| 决策点 | 建议方案 | 原因 |
|--------|----------|------|
| 路由库 | react-router-dom v6 | 成熟稳定，支持嵌套路由 |
| 密码存储 | SHA-256 哈希 | 安全性，避免明文存储 |
| Mock 方案 | Vite 插件 + localStorage | 简单，无需额外服务器 |
| 状态管理 | React Context + useReducer | 避免引入额外依赖 |

---

## 四、风险与注意事项

1. **数据迁移**：现有数据需要迁移到新结构，需要编写迁移脚本
2. **向后兼容**：确保旧数据格式仍能正常加载
3. **URI 冲突**：需要验证 URI 唯一性，避免路由冲突
4. **密码安全**：管理员密码应使用哈希存储，不能明文
5. **性能**：嵌套分组可能影响渲染性能，需要优化

---

## 五、执行优先级

```
高优先级（核心功能）：
├── 阶段 1：项目基础搭建
├── 阶段 2：数据模型重构
├── 阶段 3：后端 API 重构
├── 阶段 5：初始化流程实现
└── 阶段 9：Mock API 实现

中优先级（主要功能）：
├── 阶段 4：前端路由实现
├── 阶段 6：分组管理功能增强
└── 阶段 7：分组访问验证

低优先级（优化）：
├── 阶段 8：前端代码优化
└── 阶段 10：测试与文档
```

---

## 六、更新日志

| 日期 | 阶段 | 完成内容 |
|------|------|----------|
| 2026-01-13 | 阶段 1 | 项目基础搭建完成：复制项目结构、清理环境变量、更新 Env 接口 |
| 2026-01-13 | 阶段 3 | 后端 API 重构：storage.ts 和 link.ts 已更新，支持 KV 存储管理员密码 |
| 2026-01-13 | 阶段 9 | Mock API 实现：创建 mockApi.ts，支持本地开发 |
| 2026-01-13 | 阶段 2 | 数据模型重构：扩展 Category 接口，新增 uri/parentId/inheritPassword 字段 |
| 2026-01-13 | 阶段 4 | 前端路由：安装 react-router-dom，配置基础路由结构 |
| 2026-01-13 | 阶段 5 | 初始化流程：创建 InitSetupPage 组件，实现密码设置和强度验证 |
| 2026-01-13 | 阶段 4.4-4.5 | App.tsx 集成路由：根据 URL 加载分组，侧边栏使用 Link 组件和嵌套树形展示 |
| 2026-01-13 | 阶段 6 | 分组管理增强：CategoryManagerModal 支持 URI、父分组选择、密码继承设置 |
| 2026-01-13 | 阶段 7 | 分组访问验证：增强 CategoryAuthModal 支持密码继承验证，实现会话级解锁状态 |
| 2026-01-13 | 阶段 8 | 前端代码优化：创建 hooks（useCategories, useLinks, useSearch）、contexts（AuthContext, DataContext）、layout 组件（Sidebar, Header）|
| 2026-01-13 | 阶段 3.4 | 新增分组路由 API：storage.ts 和 mockApi.ts 支持 `GET /api/storage?uri={path}` 根据 URI 获取分组数据 |
| 2026-01-13 | 阶段 8.5 | TypeScript 严格模式：启用 strict 模式，安装 @cloudflare/workers-types，修复主要类型错误 |
